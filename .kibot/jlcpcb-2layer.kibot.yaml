kibot:
  version: 1

preflight:
  # Run ERC and DRC checks - builds will fail if errors are found
  erc: true
  drc: true
  check_zone_fills: true
  # Update XML fields from schematic
  update_xml: true
  # Ignore unconnected items that are intentional
  filters:
    - filter: 'Ignore unconnected pin warnings for mounting holes'
      error: 'unconnected'
      regex: 'MountingHole'

outputs:
  #
  # Manufacturing Files for JLCPCB
  #
  - name: gerbers
    comment: 'Gerber files for JLCPCB 2-layer boards'
    type: gerber
    dir: gerbers
    layers:
      - layer: F.Cu
        suffix: F_Cu
      - layer: B.Cu
        suffix: B_Cu
      - layer: F.SilkS
        suffix: F_SilkS
      - layer: B.SilkS
        suffix: B_SilkS
      - layer: F.Mask
        suffix: F_Mask
      - layer: B.Mask
        suffix: B_Mask
      - layer: Edge.Cuts
        suffix: Edge_Cuts

  - name: drill
    comment: 'Excellon drill files (PTH and NPTH separate for JLCPCB)'
    type: excellon
    dir: gerbers
    options:
      metric_units: true
      pth_and_npth_single_file: false
      use_aux_axis_as_origin: false
      minimal_header: false
      mirror_y_axis: false

  #
  # Assembly Files
  #
  - name: bom
    comment: 'Bill of Materials in JLCPCB format'
    type: bom
    dir: bom
    options:
      output: '%f_bom_jlc.%x'
      exclude_filter: 'only_jlc_parts'
      csv:
        hide_pcb_info: true
        hide_stats_info: true
        quote_all: true
      columns:
        - field: References
          name: Designator
        - field: Value
          name: Comment
        - field: Footprint
          name: Footprint
        - field: 'LCSC Part'
          name: 'LCSC Part #'
          join: []

  - name: position
    comment: 'Component position file for JLCPCB assembly'
    type: position
    dir: position
    options:
      format: CSV
      units: millimeters
      separate_files_for_front_and_back: false
      only_smd: false
      output: '%f_cpl_jlc.%x'
      columns:
        - id: Ref
          name: Designator
        - Val
        - Package
        - id: PosX
          name: "Mid X"
        - id: PosY
          name: "Mid Y"
        - id: Rot
          name: Rotation
        - id: Side
          name: Layer

  - name: csvbom
    comment: 'Bill of Materials in CSV format for the docs'
    type: bom
    dir: bom
    options:
      output: '%f_bom.%x'
      group_fields: ['part', 'part lib', 'value', 'footprint', 'footprint lib', 'voltage', 'tolerance', 'current', 'power', 'Note']
      ref_separator: ', '
      csv:
        hide_pcb_info: true
        hide_stats_info: true
        quote_all: true
      columns:
        - field: References
          name: Designator
        - field: '${QUANTITY}'
          name: Qty
        - field: Value
          name: Value
        - field: Datasheet
          name: Datasheet
        - field: Note
          name: Note
        - field: Reference_Part
          name: 'Reference Part'

  - name: ibom
    comment: 'Interactive HTML BOM for assembly'
    type: ibom
    dir: ibom
    options:
      dark_mode: true
      hide_pads: false
      show_fabrication: false
      hide_silkscreen: false
      highlight_pin1: true
      no_redraw_on_drag: false
      board_rotation: 0
      checkboxes: 'Sourced,Placed'
      extra_fields: "Note,Datasheet"
      extra_data_file: "%F.kicad_pcb"
      bom_view: 'left-right'
      layer_view: 'FB'
      name_format: '%p_interactive_bom'

  #
  # Documentation - Schematics
  #
  - name: schematic_pdf
    comment: 'Schematic in PDF format'
    type: pdf_sch_print
    dir: docs/schematics
    options:
      output: '%f_schematic.%x'
      color_theme: '_builtin_default'
      background_color: true
      all_pages: true
      monochrome: false

  - name: schematic_svg
    comment: 'Schematic in SVG format for web'
    type: svg_sch_print
    dir: docs/schematics
    options:
      output: '%f_schematic.%x'
      all_pages: true
      color_theme: '_builtin_default'
      background_color: true

  #
  # Documentation - PCB Views
  #
  - name: pcb_top_pdf
    comment: 'PCB top view fabrication drawing'
    type: pcb_print
    dir: docs/pcb
    options:
      output: '%f_pcb_fabrication.%x'
      format: PDF
      pages:
        - layers:
            - layer: F.Cu
            - layer: F.SilkS
            - layer: Dwgs.User
            - layer: Edge.Cuts
          sheet: 'Top View'
        - layers:
            - layer: B.Cu
            - layer: B.SilkS
            - layer: Dwgs.User
            - layer: Edge.Cuts
          sheet: 'Bottom View'
          mirror: true
        - layers:
            - layer: F.Fab
            - layer: Dwgs.User
            - layer: Edge.Cuts
          sheet: 'Fabrication Layer'

  - name: board_dimensions
    comment: 'Board dimensions drawing'
    type: pcb_print
    dir: docs/pcb
    options:
      output: '%f_dimensions.%x'
      format: SVG
      pages:
        - layers:
            - layer: Edge.Cuts
            - layer: Dwgs.User
          sheet: 'Board Outline'

  #
  # 3D Renders
  #
  - name: render_top
    comment: '3D render from top'
    type: render_3d
    dir: docs/renders
    options:
      output: '%f_3D_top.%x'
      view: 'top'
      ray_tracing: true
      orthographic: true
      auto_crop: true
      download: true
      zoom: 0
      rotate_x: 0
      rotate_y: 0
      rotate_z: 0
      background1: '#66667F'
      background2: '#CCCCE5'
      width: 1920
      height: 1080
      wait_render: -10

  - name: render_bottom
    comment: '3D render from bottom'
    type: render_3d
    dir: docs/renders
    options:
      output: '%f_3D_bottom.%x'
      view: 'bottom'
      ray_tracing: true
      orthographic: true
      auto_crop: true
      download: true
      zoom: 0
      rotate_x: 0
      rotate_y: 0
      rotate_z: 0
      background1: '#66667F'
      background2: '#CCCCE5'
      width: 1920
      height: 1080
      wait_render: -10

  - name: render_perspective
    comment: '3D render perspective view'
    type: render_3d
    dir: docs/renders
    options:
      output: '%f_3D_perspective.%x'
      view: 'top'
      ray_tracing: true
      orthographic: false
      auto_crop: true
      download: true
      zoom: 0
      rotate_x: 3
      rotate_y: 0
      rotate_z: -3
      background1: '#66667F'
      background2: '#CCCCE5'
      width: 1920
      height: 1080
      wait_render: -10

  - name: render_panel_top
    comment: '3D render from top'
    type: render_3d
    dir: docs/renders
    options:
      output: '%f_3D_top.%x'
      view: 'top'
      ray_tracing: true
      orthographic: true
      auto_crop: true
      download: true
      zoom: 0
      rotate_x: 0
      rotate_y: 0
      rotate_z: 0
      background1: '#66667F'
      background2: '#CCCCE5'
      board: '#1C2630'
      width: 1920
      height: 1080
      wait_render: -10

  - name: render_panel_bottom
    comment: '3D render from bottom'
    type: render_3d
    dir: docs/renders
    options:
      output: '%f_3D_bottom.%x'
      view: 'bottom'
      ray_tracing: true
      orthographic: true
      auto_crop: true
      download: true
      zoom: 0
      rotate_x: 0
      rotate_y: 0
      rotate_z: 0
      background1: '#66667F'
      background2: '#CCCCE5'
      board: '#1C2630'
      width: 1920
      height: 1080
      wait_render: -10

  - name: render_panel_perspective
    comment: '3D render perspective view'
    type: render_3d
    dir: docs/renders
    options:
      output: '%f_3D_perspective.%x'
      view: 'top'
      ray_tracing: true
      orthographic: false
      auto_crop: true
      download: true
      zoom: 0
      rotate_x: 3
      rotate_y: 0
      rotate_z: -3
      background1: '#66667F'
      background2: '#CCCCE5'
      board: '#1C2630'
      width: 1920
      height: 1080
      wait_render: -10

  #
  # Blender Exports for High Quality Renders
  #
  # Commented out - not used in GitHub Actions or documentation builds
  # - name: blender_export_board
  #   comment: 'Export board to Blender native format'
  #   type: blender_export
  #   dir: blender
  #   options:
  #     outputs:
  #       - type: blender
  #     pcb_import:
  #       center: true
  #       cut_boards: false
  #       enhance_materials: true
  #       stack_boards: false
  #     point_of_view:
  #       rotate_x: 30
  #       rotate_y: 0
  #       rotate_z: -30
  #       view: Z

  # Commented out - not used in GitHub Actions or documentation builds
  # - name: blender_render_stacked
  #   comment: 'High-quality Blender render of stacked boards'
  #   type: blender_export
  #   dir: docs/renders/blender
  #   options:
  #     outputs:
  #       - type: render
  #     render_options:
  #       samples: 100
  #       resolution_x: 1920
  #       resolution_y: 1080
  #       transparent_background: false
  #     pcb_import:
  #       center: true
  #       cut_boards: false
  #       enhance_materials: true
  #       stack_boards: false
  #     point_of_view:
  #       rotate_x: 30
  #       rotate_y: 0
  #       rotate_z: -30
  #       view: Z

  #
  # STEP file for mechanical design
  #
  - name: step
    comment: 'STEP 3D model'
    type: step
    dir: mechanical
    options:
      output: '%f.%x'
      no_virtual: false
      min_distance: -1
      metric_units: true
      origin: grid
      download: true
      kicad_3d_url: 'https://gitlab.com/kicad/libraries/kicad-packages3D/-/raw/master/'

  #
  # PCB3D Export for Blender (pcb2blender plugin)
  #
  - name: pcb3d_tools
    comment: 'PCB data for pcb2blender'
    type: pcb2blender_tools
    dir: 'blender/%f_pcb3d'
    options:
      stackup_create: true
      stackup_file: stackup
      stackup_dir: layers
      stackup_format: BIN

  - name: pcb3d_layers
    comment: 'Layer SVGs for pcb2blender'
    type: svg
    dir: 'blender/%f_pcb3d/layers'
    options:
      output: "%i.%x"
      margin: 1
      limit_viewbox: true
      svg_precision: 6
      drill_marks: none
    layers:
      - F.Cu
      - B.Cu
      - F.Paste
      - B.Paste
      - layer: F.SilkS
        suffix: F_SilkS
      - layer: B.SilkS
        suffix: B_SilkS
      - F.Mask
      - B.Mask

  - name: pcb3d_vrml
    comment: 'VRML 3D models for pcb2blender'
    type: vrml
    dir: 'blender/%f_pcb3d'
    options:
      output: pcb.wrl
      dir_models: components
      use_pcb_center_as_ref: false
      model_units: meters
      download: true

  - name: pcb3d
    comment: 'Complete PCB3D file for Blender import'
    type: compress
    dir: blender
    options:
      output: '%f.pcb3d'
      format: ZIP
      files:
        - from_output: pcb3d_tools
          from_output_dir: true
        - from_output: pcb3d_layers
          dest: layers
        - from_output: pcb3d_vrml
          from_output_dir: true

  #
  # Assembly Documentation
  #
  # Note: pcbdraw outputs removed due to missing resources in CI environment
  # Position CSV and interactive BOM provide assembly guidance

  #
  # Diff outputs (for comparing versions)
  #
  - name: pcb_diff
    comment: 'PCB visual diff between commits'
    type: pcb_variant
    dir: diff
    options:
      output: '%f_diff.%x'
      # This requires git history to compare
      # Only works in CI/CD with multiple commits

  #
  # Note: DRC and ERC checks run automatically in preflight section
  # Reports are generated automatically, no separate output needed
  #

  #
  # Zip archives for production
  #
  - name: gerbers_zip
    comment: 'Gerbers and drill files in ZIP for JLCPCB'
    type: compress
    dir: production
    options:
      output: '%f_gerbers_jlcpcb.%x'
      format: ZIP
      files:
        - from_output: gerbers
          dest: /
        - from_output: drill
          dest: /

  - name: docs_archive
    comment: 'All documentation in ZIP'
    type: compress
    dir: production
    options:
      output: '%f_documentation.%x'
      format: ZIP
      files:
        - from_output: schematic_pdf
        - from_output: pcb_top_pdf
        - from_output: render_top
        - from_output: render_bottom
        - from_output: render_perspective

filters:
  - name: 'only_jlc_parts'
    comment: 'Only parts with LCSC part numbers for JLCPCB assembly'
    type: generic
    exclude_any:
      - column: 'LCSC Part'
        regex: '^$'
